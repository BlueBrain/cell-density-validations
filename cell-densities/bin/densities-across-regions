#!/usr/bin/env python
import sys
import pandas

from nrrdhlp.find_atlas_files import load_all_densities, find_hierarchy, find_regions
from nrrdhlp.hierarchyhlp import list_cortex_regions
from nrrdhlp import Masker

layers = ["1", "2/3", "2", "3", "4", "5", "6"]


def compare_across_regions(densities, masker, lst_regions):
    vxl_vol = masker.annotation.voxel_volume
    res_raw = []
    for i, l in enumerate(layers):
        print(str(i))
        for reg in lst_regions:
            mask = masker.mask(["and", ["Layer" + l, reg]])
            mask_vol = mask.sum() * vxl_vol
            for mtype, dens in densities.items():
                value = dens.raw[mask].mean()
                res_raw.append((mtype, l, reg, value, mask_vol))

    res_raw = pandas.DataFrame(res_raw, columns=["Mtype", "Layer", "Region", "Density", "Volume"])
    res = pandas.DataFrame(res_raw[["Density", "Volume"]].values, columns=["Density", "Volume"],
                           index=pandas.MultiIndex.from_frame(res_raw[["Mtype", "Layer", "Region"]]))
    return res


def main(root):
    densities = load_all_densities(root)
    full_fn_hierarchy = find_hierarchy(root, format="path")
    if full_fn_hierarchy is None:
        print("No region hierarchy file found under {0}.".format(root))
        sys.exit(2)
    hier_json = find_hierarchy(root, format="json")
    full_fn_regions = find_regions(root, format="path")
    if full_fn_regions is None:
        print("No region annotation file found under {0}.".format(root))
        sys.exit(2)
    masker = Masker(full_fn_hierarchy, full_fn_regions)
    lst_regions = list_cortex_regions(hier_json, root_acronym="Isocortex")
    return compare_across_regions(densities, masker, lst_regions)


if __name__ == "__main__":
    root = sys.argv[1]
    out_fn = sys.argv[2]
    res = main(root)
    res.to_pickle(out_fn)
